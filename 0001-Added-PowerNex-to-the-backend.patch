From 8e24aab36f258a20bb43d97d5baab02bbe5870f7 Mon Sep 17 00:00:00 2001
From: Dan Printzell <xwildn00bx@gmail.com>
Date: Tue, 30 Jan 2018 22:39:14 +0100
Subject: [PATCH 1/4] Added PowerNex to the backend

Signed-off-by: Dan Printzell <xwildn00bx@gmail.com>
---
 src/dmd/backend/backconfig.c             | 23 +++++++++++++++++++----
 src/dmd/backend/cc.h                     |  4 ++--
 src/dmd/backend/cdef.d                   |  4 +++-
 src/dmd/backend/cdef.h                   | 26 ++++++++++++++++++++------
 src/dmd/backend/cgcod.c                  |  2 +-
 src/dmd/backend/cgelem.c                 |  2 +-
 src/dmd/backend/cod1.c                   | 29 +++++++++++++++--------------
 src/dmd/backend/cod2.c                   |  6 +++---
 src/dmd/backend/cod3.c                   | 24 ++++++++++++------------
 src/dmd/backend/cod4.c                   |  6 +++---
 src/dmd/backend/code_stub.h              |  2 +-
 src/dmd/backend/code_x86.h               |  2 +-
 src/dmd/backend/el.c                     | 14 +++++++-------
 src/dmd/backend/elfobj.c                 |  6 ++++--
 src/dmd/backend/global.h                 |  2 +-
 src/dmd/backend/machobj.c                |  6 +++---
 src/dmd/backend/obj.h                    |  2 +-
 src/dmd/backend/optabgen.c               |  2 +-
 src/dmd/backend/out.c                    |  2 +-
 src/dmd/backend/token.h                  |  4 ++--
 src/dmd/backend/ty.h                     |  6 +++---
 src/dmd/backend/var.c                    |  2 +-
 src/dmd/cond.d                           |  1 +
 src/dmd/e2ir.d                           |  5 +++--
 src/dmd/globals.d                        | 10 ++++++----
 src/dmd/globals.h                        |  1 +
 src/dmd/lib.d                            |  4 ++--
 src/dmd/mars.d                           | 21 ++++++++++++++++-----
 src/dmd/mars.h                           |  2 ++
 src/dmd/target.d                         | 21 +++++++++++++--------
 src/dmd/toir.d                           |  6 +++---
 test/fail_compilation/reserved_version.d |  3 +++
 32 files changed, 155 insertions(+), 95 deletions(-)

diff --git a/src/dmd/backend/backconfig.c b/src/dmd/backend/backconfig.c
index 14fe073f7..e56a21b16 100644
--- a/src/dmd/backend/backconfig.c
+++ b/src/dmd/backend/backconfig.c
@@ -196,6 +196,21 @@ void out_config_init(
         config.flags3 |= CFG3pic;
     config.objfmt = OBJ_ELF;
     config.ehmethod = betterC ? EH_NONE : EH_DM;
+#endif
+#if TARGET_POWERNEX
+		// Based on TARGET_LINUX
+		// 32bit is not supported!
+    config.exe = EX_POWERNEX64;
+		config.ehmethod = EH_DWARF;
+		config.fpxmmregs = TRUE;
+		config.avx = avx;
+    config.flags |= CFGnoebp;
+    if (!exe)
+    {
+        config.flags3 |= CFG3pic;
+        config.flags |= CFGalwaysframe; // PIC needs a frame for TLS fixups
+    }
+    config.objfmt = OBJ_ELF;
 #endif
     config.flags2 |= CFG2nodeflib;      // no default library
     config.flags3 |= CFG3eseqds;
@@ -336,7 +351,7 @@ void util_set32()
     _tysize[TYnullptr] = LONGSIZE;
     _tysize[TYnptr] = LONGSIZE;
     _tysize[TYnref] = LONGSIZE;
-#if TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
     _tysize[TYldouble] = 12;
     _tysize[TYildouble] = 12;
     _tysize[TYcldouble] = 24;
@@ -363,7 +378,7 @@ void util_set32()
     _tyalignsize[TYnullptr] = LONGSIZE;
     _tyalignsize[TYnref] = LONGSIZE;
     _tyalignsize[TYnptr] = LONGSIZE;
-#if TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
     _tyalignsize[TYldouble] = 4;
     _tyalignsize[TYildouble] = 4;
     _tyalignsize[TYcldouble] = 4;
@@ -401,7 +416,7 @@ void util_set64()
     _tysize[TYnullptr] = 8;
     _tysize[TYnptr] = 8;
     _tysize[TYnref] = 8;
-#if TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_OSX
+#if TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_OSX || TARGET_POWERNEX
     _tysize[TYldouble] = 16;
     _tysize[TYildouble] = 16;
     _tysize[TYcldouble] = 32;
@@ -424,7 +439,7 @@ void util_set64()
     _tyalignsize[TYnullptr] = 8;
     _tyalignsize[TYnptr] = 8;
     _tyalignsize[TYnref] = 8;
-#if TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
     _tyalignsize[TYldouble] = 16;
     _tyalignsize[TYildouble] = 16;
     _tyalignsize[TYcldouble] = 16;
diff --git a/src/dmd/backend/cc.h b/src/dmd/backend/cc.h
index 10ed38b33..f0f8fcc47 100644
--- a/src/dmd/backend/cc.h
+++ b/src/dmd/backend/cc.h
@@ -77,7 +77,7 @@ enum WM
         WM_badnumber    = 24,
         WM_ccast        = 25,
         WM_obsolete     = 26,
-#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
         WM_skip_attribute   = 27, // skip GNUC attribute specification
         WM_warning_message  = 28, // preprocessor warning message
         WM_bad_vastart      = 29, // args for builtin va_start bad
@@ -106,7 +106,7 @@ enum LANG
 #include        "msgs2.h"
 #endif
 #include        "ty.h"
-#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
 #include        "../tk/mem.h"
 #else
 #include        "mem.h"
diff --git a/src/dmd/backend/cdef.d b/src/dmd/backend/cdef.d
index 1721d29af..ed2b0f40b 100644
--- a/src/dmd/backend/cdef.d
+++ b/src/dmd/backend/cdef.d
@@ -500,6 +500,7 @@ enum
     EX_SOLARIS64    = 0x200000,
     EX_OPENBSD      = 0x400000,
     EX_OPENBSD64    = 0x800000,
+    EX_POWERNEX64   = 0x1000000,
 }
 
 
@@ -507,7 +508,8 @@ enum
 enum exefmt_t EX_flat = EX_OS2 | EX_WIN32 | EX_LINUX | EX_WIN64 | EX_LINUX64 |
                          EX_OSX | EX_OSX64 | EX_FREEBSD | EX_FREEBSD64 |
                          EX_OPENBSD | EX_OPENBSD64 |
-                         EX_SOLARIS | EX_SOLARIS64;
+                         EX_SOLARIS | EX_SOLARIS64 |
+                         EX_POWERNEX64;
 
 // All DOS executable types
 enum exefmt_t EX_dos =  EX_DOSX | EX_ZPM | EX_RATIONAL | EX_PHARLAP |
diff --git a/src/dmd/backend/cdef.h b/src/dmd/backend/cdef.h
index 5f81c2210..d9b3c34f7 100644
--- a/src/dmd/backend/cdef.h
+++ b/src/dmd/backend/cdef.h
@@ -27,6 +27,7 @@
         __FreeBSD__     FreeBSD
         __OpenBSD__     OpenBSD
         __sun           Solaris, OpenSolaris, SunOS, OpenIndiana, etc
+        __PowerNex__    PowerNex
         __OS2__         IBM OS/2
         DOS386          32 bit DOS extended executable
         DOS16RM         Rational Systems 286 DOS extender
@@ -141,6 +142,12 @@ One and only one of these macros must be set by the makefile:
  * with these goals, and should be fixed.
  */
 
+/*
+ * PowerNex Version
+ * -------------
+ * I have no clue what I'm doing, but I'm based the code on Linux. :)
+ */
+
 #ifndef CDEF_H
 #define CDEF_H  1
 
@@ -191,9 +198,14 @@ One and only one of these macros must be set by the makefile:
 #define TARGET_SOLARIS  0               // target is a Solaris executable
 #endif
 
+// Set to 1 using the makefile
+#ifndef TARGET_POWERNEX
+#define TARGET_POWERNEX 0               // target is a PowerNex executable
+#endif
+
 // This is the default
 #ifndef TARGET_WINDOS
-#define TARGET_WINDOS   (!(TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS))
+#define TARGET_WINDOS   (!(TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX))
 #endif
 
 #if __GNUC__
@@ -296,7 +308,7 @@ typedef long double longdouble;
 
 // Precompiled header variations
 #define MEMORYHX        (_WINDLL && _WIN32)     // HX and SYM files are cached in memory
-#define MMFIO           (_WIN32 || __linux__ || __APPLE__ || __FreeBSD__ || __OpenBSD__ || __sun)  // if memory mapped files
+#define MMFIO           (_WIN32 || __linux__ || __APPLE__ || __FreeBSD__ || __OpenBSD__ || __sun || __PowerNex__)  // if memory mapped files
 #define LINEARALLOC     _WIN32  // if we can reserve address ranges
 
 // H_STYLE takes on one of these precompiled header methods
@@ -519,7 +531,7 @@ enum
 #define REGMASK         0xFFFF
 
 // targ_llong is also used to store host pointers, so it should have at least their size
-#if TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_OSX || MARS
+#if TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX || TARGET_OSX || MARS
 typedef targ_llong      targ_ptrdiff_t; /* ptrdiff_t for target machine  */
 typedef targ_ullong     targ_size_t;    /* size_t for the target machine */
 #else
@@ -542,14 +554,14 @@ typedef targ_uns        targ_size_t;    /* size_t for the target machine */
 #define OMFOBJ          TARGET_WINDOS
 #endif
 #ifndef ELFOBJ
-#define ELFOBJ          (TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS)
+#define ELFOBJ          (TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX)
 #endif
 #ifndef MACHOBJ
 #define MACHOBJ         TARGET_OSX
 #endif
 
 #define SYMDEB_CODEVIEW TARGET_WINDOS
-#define SYMDEB_DWARF    (TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_OSX)
+#define SYMDEB_DWARF    (TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX || TARGET_OSX)
 
 #define TOOLKIT_H
 
@@ -737,6 +749,7 @@ enum
     EX_SOLARIS64    = 0x200000,
     EX_OPENBSD      = 0x400000,
     EX_OPENBSD64    = 0x800000,
+    EX_POWERNEX64   = 0x1000000,
 };
 
 
@@ -744,7 +757,8 @@ enum
 const exefmt_t EX_flat = EX_OS2 | EX_WIN32 | EX_LINUX | EX_WIN64 | EX_LINUX64 |
                          EX_OSX | EX_OSX64 | EX_FREEBSD | EX_FREEBSD64 |
                          EX_OPENBSD | EX_OPENBSD64 |
-                         EX_SOLARIS | EX_SOLARIS64;
+                         EX_SOLARIS | EX_SOLARIS64 |
+                         EX_POWERNEX64;
 
 // All DOS executable types
 const exefmt_t EX_dos =  EX_DOSX | EX_ZPM | EX_RATIONAL | EX_PHARLAP |
diff --git a/src/dmd/backend/cgcod.c b/src/dmd/backend/cgcod.c
index 8682df3c5..77c621636 100644
--- a/src/dmd/backend/cgcod.c
+++ b/src/dmd/backend/cgcod.c
@@ -2543,7 +2543,7 @@ reload:                                 /* reload result from memory    */
         case OPrelconst:
             cdrelconst(cdb,e,pretregs);
             break;
-#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
         case OPgot:
             cdgot(cdb,e,pretregs);
             break;
diff --git a/src/dmd/backend/cgelem.c b/src/dmd/backend/cgelem.c
index f2712a016..7d3e51bc0 100644
--- a/src/dmd/backend/cgelem.c
+++ b/src/dmd/backend/cgelem.c
@@ -5040,7 +5040,7 @@ STATIC elem * elvalist(elem *e, goal_t goal)
 
 #endif
 
-#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
 
     assert(I64); // va_start is not an intrinsic on 32-bit
     // (OPva_start &va)
diff --git a/src/dmd/backend/cod1.c b/src/dmd/backend/cod1.c
index 6f2394d4c..105ae7542 100644
--- a/src/dmd/backend/cod1.c
+++ b/src/dmd/backend/cod1.c
@@ -1285,7 +1285,7 @@ void getlvalue(CodeBuilder& cdb,code *pcs,elem *e,regm_t keepmsk)
     case FLextern:
         if (s->Sident[0] == '_' && memcmp(s->Sident + 1,"tls_array",10) == 0)
         {
-#if TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
             // Rewrite as GS:[0000], or FS:[0000] for 64 bit
             if (I64)
             {
@@ -1329,7 +1329,7 @@ void getlvalue(CodeBuilder& cdb,code *pcs,elem *e,regm_t keepmsk)
     case FLcsdata:
     case FLgot:
     case FLgotoff:
-#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
     case FLtlsdata:
 #endif
     L3:
@@ -1889,11 +1889,12 @@ void getClibInfo(unsigned clib, symbol **ps, ClibInfo **pinfo)
         clib_inited = true;
     }
 
-    const unsigned ex_unix = (EX_LINUX   | EX_LINUX64   |
-                              EX_OSX     | EX_OSX64     |
-                              EX_FREEBSD | EX_FREEBSD64 |
-                              EX_OPENBSD | EX_OPENBSD64 |
-                              EX_SOLARIS | EX_SOLARIS64);
+    const unsigned ex_unix = (EX_LINUX     | EX_LINUX64   |
+                              EX_OSX       | EX_OSX64     |
+                              EX_FREEBSD   | EX_FREEBSD64 |
+                              EX_OPENBSD   | EX_OPENBSD64 |
+                              EX_SOLARIS   | EX_SOLARIS64 |
+                              EX_POWERNEX64);
 
     ClibInfo *cinfo = &clibinfo[clib];
     symbol *s = clibsyms[clib];
@@ -1918,7 +1919,7 @@ void getClibInfo(unsigned clib, symbol **ps, ClibInfo **pinfo)
                 break;
             case CLIBldiv:
                 cinfo->retregs16 = mDX|mAX;
-                if (config.exe & (EX_LINUX | EX_FREEBSD))
+                if (config.exe & (EX_LINUX | EX_FREEBSD | EX_POWERNEX64))
                 {
                     s = symboly("__divdi3", mAX|mBX|mCX|mDX);
                     cinfo->flags = INFpushebx;
@@ -1945,7 +1946,7 @@ void getClibInfo(unsigned clib, symbol **ps, ClibInfo **pinfo)
                 break;
             case CLIBlmod:
                 cinfo->retregs16 = mCX|mBX;
-                if (config.exe & (EX_LINUX | EX_FREEBSD))
+                if (config.exe & (EX_LINUX | EX_FREEBSD | EX_POWERNEX64))
                 {
                     s = symboly("__moddi3", mAX|mBX|mCX|mDX);
                     cinfo->flags = INFpushebx;
@@ -1972,7 +1973,7 @@ void getClibInfo(unsigned clib, symbol **ps, ClibInfo **pinfo)
                 break;
             case CLIBuldiv:
                 cinfo->retregs16 = mDX|mAX;
-                if (config.exe & (EX_LINUX | EX_FREEBSD))
+                if (config.exe & (EX_LINUX | EX_FREEBSD | EX_POWERNEX64))
                 {
                     s = symboly("__udivdi3", mAX|mBX|mCX|mDX);
                     cinfo->flags = INFpushebx;
@@ -1999,7 +2000,7 @@ void getClibInfo(unsigned clib, symbol **ps, ClibInfo **pinfo)
                 break;
             case CLIBulmod:
                 cinfo->retregs16 = mCX|mBX;
-                if (config.exe & (EX_LINUX | EX_FREEBSD))
+                if (config.exe & (EX_LINUX | EX_FREEBSD | EX_POWERNEX64))
                 {
                     s = symboly("__umoddi3", mAX|mBX|mCX|mDX);
                     cinfo->flags = INFpushebx;
@@ -2572,7 +2573,7 @@ void callclib(CodeBuilder& cdb,elem *e,unsigned clib,regm_t *pretregs,regm_t kee
         }
         if (pushebx)
         {
-            if (config.exe & (EX_LINUX | EX_LINUX64 | EX_FREEBSD | EX_FREEBSD64))
+            if (config.exe & (EX_LINUX | EX_LINUX64 | EX_FREEBSD | EX_FREEBSD64 | EX_POWERNEX64))
             {
                 cdb.gen1(0x50 + CX);                             // PUSH ECX
                 cdb.gen1(0x50 + BX);                             // PUSH EBX
@@ -3409,7 +3410,7 @@ static void funccall(CodeBuilder& cdb,elem *e,unsigned numpara,unsigned numalign
                 fl = el_fl(e1);
             if (tym1 == TYifunc)
                 cdbe.gen1(0x9C);                             // PUSHF
-#if TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
             assert(!farfunc);
             if (s != tls_get_addr_sym)
             {
@@ -3448,7 +3449,7 @@ static void funccall(CodeBuilder& cdb,elem *e,unsigned numpara,unsigned numalign
         tym_t e11ty = tybasic(e11->Ety);
         assert(!I16 || (e11ty == (farfunc ? TYfptr : TYnptr)));
         load_localgot(cdb);
-#if TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
         if (config.flags3 & CFG3pic && I32)
             keepmsk |= mBX;
 #endif
diff --git a/src/dmd/backend/cod2.c b/src/dmd/backend/cod2.c
index eecbba919..89424cd5b 100755
--- a/src/dmd/backend/cod2.c
+++ b/src/dmd/backend/cod2.c
@@ -909,7 +909,7 @@ void cdmul(CodeBuilder& cdb,elem *e,regm_t *pretregs)
             orthxmm(cdb,e,pretregs);
             return;
         }
-#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
         orth87(cdb,e,pretregs);
 #else
         opdouble(cdb,e,pretregs,(oper == OPmul) ? CLIBdmul : CLIBddiv);
@@ -4145,7 +4145,7 @@ void getoffset(CodeBuilder& cdb,elem *e,unsigned reg)
         goto L4;
 
     case FLtlsdata:
-#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
     {
       L5:
         if (config.flags3 & CFG3pic)
@@ -4271,7 +4271,7 @@ void getoffset(CodeBuilder& cdb,elem *e,unsigned reg)
         goto L4;
 
     case FLextern:
-#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
         if (e->EV.sp.Vsym->ty() & mTYthread)
             goto L5;
 #endif
diff --git a/src/dmd/backend/cod3.c b/src/dmd/backend/cod3.c
index 9c1631a4a..6e0293836 100644
--- a/src/dmd/backend/cod3.c
+++ b/src/dmd/backend/cod3.c
@@ -631,7 +631,7 @@ regm_t regmask(tym_t tym, tym_t tyf)
             return mST0;
 
         case TYcfloat:
-#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
             if (I32 && tybasic(tyf) == TYnfunc)
                 return mDX | mAX;
 #endif
@@ -1446,7 +1446,7 @@ void doswitch(CodeBuilder& cdb, block *b)
         regm_t retregs = IDXREGS;
         if (dword)
             retregs |= mMSW;
-#if TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
         if (I32 && config.flags3 & CFG3pic)
             retregs &= ~mBX;                            // need EBX for GOT
 #endif
@@ -1645,7 +1645,7 @@ void doswitch(CodeBuilder& cdb, block *b)
             genjmp(cdb,JNE,FLblock,b->nthSucc(0)); // JNE default
         }
         getregs(cdb,mCX|mDI);
-#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
         if (config.flags3 & CFG3pic)
         {   // Add in GOT
             getregs(cdb,mDX);
@@ -1720,7 +1720,7 @@ void doswitch(CodeBuilder& cdb, block *b)
         const int mod = (disp > 127) ? 2 : 1;     // 1 or 2 byte displacement
         if (csseg)
             cdb.gen1(SEGCS);            // table is in code segment
-#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
         if (config.flags3 & CFG3pic)
         {                               // ADD EDX,(ncases-1)*2[EDI]
             cdb.genc1(0x03,modregrm(mod,DX,7),FLconst,disp);
@@ -1790,7 +1790,7 @@ void outjmptab(block *b)
                         break;
                 }
         }
-#if TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
         if (I64)
         {
             if (config.flags3 & CFG3pic)
@@ -2347,7 +2347,7 @@ void cdgot(CodeBuilder& cdb, elem *e, regm_t *pretregs)
     cdb.gen1(0x58 + reg);             // L1: POP reg
 
     fixresult(cdb,e,retregs,pretregs);
-#elif TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#elif TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
     regm_t retregs = *pretregs & allregs;
     if  (!retregs)
         retregs = allregs;
@@ -2382,7 +2382,7 @@ void cdgot(CodeBuilder& cdb, elem *e, regm_t *pretregs)
 
 void load_localgot(CodeBuilder& cdb)
 {
-#if TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
     if (config.flags3 & CFG3pic && I32)
     {
         if (localgot && !(localgot->Sflags & SFLdead))
@@ -2405,7 +2405,7 @@ void load_localgot(CodeBuilder& cdb)
 #endif
 }
 
-#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
 /*****************************
  * Returns:
  *      # of bytes stored
@@ -3011,7 +3011,7 @@ void prolog_frame(CodeBuilder& cdb, unsigned farfunc, unsigned* xlocalsize, bool
     if (config.wflags & WFincbp && farfunc)
         cdb.gen1(0x40 + BP);      // INC  BP
     if (config.target_cpu < TARGET_80286 ||
-        config.exe & (EX_LINUX | EX_LINUX64 | EX_OSX | EX_OSX64 | EX_FREEBSD | EX_FREEBSD64 | EX_SOLARIS | EX_SOLARIS64 | EX_WIN64) ||
+        config.exe & (EX_LINUX | EX_LINUX64 | EX_OSX | EX_OSX64 | EX_FREEBSD | EX_FREEBSD64 | EX_SOLARIS | EX_SOLARIS64 | EX_POWERNEX64 | EX_WIN64) ||
         !localsize ||
         config.flags & CFGstack ||
         (*xlocalsize >= 0x1000 && config.exe & EX_flat) ||
@@ -4298,7 +4298,7 @@ void cod3_thunk(Symbol *sthunk,Symbol *sfunc,unsigned p,tym_t thisty,
     sthunk->Soffset = thunkoffset;
     sthunk->Ssize = Offset(seg) - thunkoffset; // size of thunk
     sthunk->Sseg = seg;
-#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
     objmod->pubdef(seg,sthunk,sthunk->Soffset);
 #endif
 #if TARGET_WINDOS
@@ -6539,7 +6539,7 @@ static void do64bit(MiniCodeBuf *pbuf, enum FL fl,union evc *uev,int flags)
             // un-named external with is the start of .rodata or .data
         case FLextern:                      /* external data symbol         */
         case FLtlsdata:
-#if TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
         case FLgot:
         case FLgotoff:
 #endif
@@ -6649,7 +6649,7 @@ static void do32bit(MiniCodeBuf *pbuf, enum FL fl,union evc *uev,int flags, int
         // un-named external with is the start of .rodata or .data
     case FLextern:                      /* external data symbol         */
     case FLtlsdata:
-#if TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
     case FLgot:
     case FLgotoff:
 #endif
diff --git a/src/dmd/backend/cod4.c b/src/dmd/backend/cod4.c
index db822c92a..2a1bac357 100644
--- a/src/dmd/backend/cod4.c
+++ b/src/dmd/backend/cod4.c
@@ -819,7 +819,7 @@ void cdaddass(CodeBuilder& cdb,elem *e,regm_t *pretregs)
 
     if (tyfloating(tyml))
     {
-#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
         if (op == OPnegass)
             cdnegass87(cdb,e,pretregs);
         else
@@ -1332,7 +1332,7 @@ void cdmulass(CodeBuilder& cdb,elem *e,regm_t *pretregs)
 
     if (tyfloating(tyml))
     {
-#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
         opass87(cdb,e,pretregs);
 #else
         opassdbl(cdb,e,pretregs,op);
@@ -2747,7 +2747,7 @@ void cdcnvt(CodeBuilder& cdb,elem *e, regm_t *pretregs)
                     cdd_u32(cdb,e,pretregs);
                     return;
                 }
-#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
                 retregs = mST0;
 #else
                 retregs = DOUBLEREGS;
diff --git a/src/dmd/backend/code_stub.h b/src/dmd/backend/code_stub.h
index f7f79bbc1..c190f2114 100644
--- a/src/dmd/backend/code_stub.h
+++ b/src/dmd/backend/code_stub.h
@@ -49,7 +49,7 @@
 #define DOUBLEREGS_16 0
 #define BYTEREGS_INIT 0
 
-#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
 extern regm_t ALLREGS;
 extern regm_t BYTEREGS;
 #define ALLREGS_INIT            0
diff --git a/src/dmd/backend/code_x86.h b/src/dmd/backend/code_x86.h
index 31de18d76..0bb8fe389 100644
--- a/src/dmd/backend/code_x86.h
+++ b/src/dmd/backend/code_x86.h
@@ -124,7 +124,7 @@ enum
 
 extern regm_t ALLREGS;
 extern regm_t BYTEREGS;
-#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
     // To support positional independent code,
     // must be able to remove BX from available registers
 #define ALLREGS_INIT            (mAX|mBX|mCX|mDX|mSI|mDI)
diff --git a/src/dmd/backend/el.c b/src/dmd/backend/el.c
index 918e78165..909decc6c 100644
--- a/src/dmd/backend/el.c
+++ b/src/dmd/backend/el.c
@@ -1165,7 +1165,7 @@ Lnodep:
 
 symbol *el_alloc_localgot()
 {
-#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
     /* Since localgot is a local variable to each function,
      * localgot must be set back to NULL
      * at the start of code gen for each function.
@@ -1337,7 +1337,7 @@ elem *el_picvar(symbol *s)
     return e;
 }
 #endif
-#if TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
 
 elem *el_picvar(symbol *s)
 {   elem *e;
@@ -1532,13 +1532,13 @@ elem * el_var(symbol *s)
 
     //printf("el_var(s = '%s')\n", s->Sident);
     //printf("%x\n", s->Stype->Tty);
-#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
     if (config.flags3 & CFG3pic &&
         !tyfunc(s->ty()))
         // Position Independent Code
         return el_picvar(s);
 #endif
-#if TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
     if (config.flags3 & CFG3pic && tyfunc(s->ty()))
     {
         switch (s->Sclass)
@@ -1564,7 +1564,7 @@ elem * el_var(symbol *s)
         //printf("thread local %s\n", s->Sident);
 #if TARGET_OSX
         ;
-#elif TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#elif TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
         /* For 32 bit:
          * Generate for var locals:
          *      MOV reg,GS:[00000000]   // add GS: override in back end
@@ -1683,7 +1683,7 @@ elem * el_var(symbol *s)
 {   elem *e;
 
     //printf("el_var(s = '%s')\n", s->Sident);
-#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
     if (config.flags3 & CFG3pic && !tyfunc(s->ty()))
         return el_picvar(s);
 #endif
@@ -1774,7 +1774,7 @@ elem * el_ptr(symbol *s)
         return e;
     }
 #endif
-#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
     if (config.flags3 & CFG3pic &&
         tyfunc(s->ty()))
         e = el_picvar(s);
diff --git a/src/dmd/backend/elfobj.c b/src/dmd/backend/elfobj.c
index bc877e592..02900e4df 100644
--- a/src/dmd/backend/elfobj.c
+++ b/src/dmd/backend/elfobj.c
@@ -54,6 +54,8 @@
 #  define ELFOSABI ELFOSABI_SYSV
 # elif TARGET_OPENBSD
 #  define ELFOSABI ELFOSABI_OPENBSD
+# elif TARGET_POWERNEX
+#  define ELFOSABI ELFOSABI_SYSV
 # else
 #  error "No ELF OS ABI defined.  Please fix"
 # endif
@@ -82,7 +84,7 @@ void addSegmentToComdat(segidx_t seg, segidx_t comdatseg);
  * If set the compiler requires full druntime support of the new
  * section registration.
  */
-#define REQUIRE_DSO_REGISTRY (DMDV2 && (TARGET_LINUX || TARGET_FREEBSD))
+#define REQUIRE_DSO_REGISTRY (DMDV2 && (TARGET_LINUX || TARGET_FREEBSD || TARGET_POWERNEX))
 
 /******
  * FreeBSD uses ELF, but the linker crashes with Elf comdats with the following message:
@@ -2238,7 +2240,7 @@ char *obj_mangle2(Symbol *s,char *dest, size_t *destlen)
             }
             break;
         case mTYman_std:
-#if TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
             if (tyfunc(s->ty()) && !variadic(s->Stype))
 #else
             if (!(config.flags4 & CFG4oldstdmangle) &&
diff --git a/src/dmd/backend/global.h b/src/dmd/backend/global.h
index 27068e956..9c893ab09 100644
--- a/src/dmd/backend/global.h
+++ b/src/dmd/backend/global.h
@@ -489,7 +489,7 @@ void dwarf_CFA_set_reg_offset(int reg, int offset);
 void dwarf_CFA_offset(int reg, int offset);
 void dwarf_CFA_args_size(size_t sz);
 
-// TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+// TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
 elem *exp_isconst();
 elem *lnx_builtin_next_arg(elem *efunc,list_t arglist);
 char *lnx_redirect_funcname(const char *);
diff --git a/src/dmd/backend/machobj.c b/src/dmd/backend/machobj.c
index d8ea573f0..90e0af627 100644
--- a/src/dmd/backend/machobj.c
+++ b/src/dmd/backend/machobj.c
@@ -18,11 +18,11 @@
 #include        <fcntl.h>
 #include        <ctype.h>
 
-#if _WIN32 || __linux__
+#if _WIN32 || __linux__ || __PowerNex__
 #include        <malloc.h>
 #endif
 
-#if __linux__ || __APPLE__ || __FreeBSD__ || __OpenBSD__ || __sun
+#if __linux__ || __APPLE__ || __FreeBSD__ || __OpenBSD__ || __sun || __PowerNex__
 #include        <signal.h>
 #include        <unistd.h>
 #endif
@@ -2092,7 +2092,7 @@ char *obj_mangle2(Symbol *s,char *dest)
                 *p = toupper(*p);
             break;
         case mTYman_std:
-#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
             if (tyfunc(s->ty()) && !variadic(s->Stype))
 #else
             if (!(config.flags4 & CFG4oldstdmangle) &&
diff --git a/src/dmd/backend/obj.h b/src/dmd/backend/obj.h
index 5820eee6e..d6610d969 100644
--- a/src/dmd/backend/obj.h
+++ b/src/dmd/backend/obj.h
@@ -193,7 +193,7 @@ class Obj
 
     static void gotref(symbol *s);
 
-#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
     static unsigned addstr(Outbuffer *strtab, const char *);
     static symbol *getGOTsym();
     static void refGOTsym();
diff --git a/src/dmd/backend/optabgen.c b/src/dmd/backend/optabgen.c
index d52920a00..d1a6be11e 100644
--- a/src/dmd/backend/optabgen.c
+++ b/src/dmd/backend/optabgen.c
@@ -1035,7 +1035,7 @@ void dotytab()
             case TYcldouble:
 #if TARGET_OSX
                 sz = 16;
-#elif TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#elif TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
                 sz = 4;
 #elif TARGET_WINDOS
                 sz = 2;
diff --git a/src/dmd/backend/out.c b/src/dmd/backend/out.c
index 7ac9c8603..4556fcc9b 100644
--- a/src/dmd/backend/out.c
+++ b/src/dmd/backend/out.c
@@ -376,7 +376,7 @@ void dt_writeToObj(Obj& objmod, dt_t *dt, int seg, targ_size_t& offset)
                 if (tybasic(dt->Dty) == TYcptr)
                     objmod.reftocodeseg(seg,offset,dt->DTabytes);
                 else
-#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
                     objmod.reftodatseg(seg,offset,dt->DTabytes,dt->DTseg,flags);
 #else
                 /*else*/ if (dt->DTseg == DATA)
diff --git a/src/dmd/backend/token.h b/src/dmd/backend/token.h
index 6256500c4..5eff1434e 100644
--- a/src/dmd/backend/token.h
+++ b/src/dmd/backend/token.h
@@ -171,7 +171,7 @@ enum TK {
         TK_stdcall,
         TK_syscall,
         TK_try,
-#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
         TK_attribute,
         TK_extension,
         TK_format,
@@ -203,7 +203,7 @@ enum TK {
         TKandand,TKshl,TKshr,TKrcur,TKeq,TKaddass,TKminass,TKmulass,TKdivass,
         TKmodass,TKshrass,TKshlass,TKandass,TKxorass,TKorass,TKsemi,
         TKadd,TKellipsis,
-#if !TX86 || TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if !TX86 || TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
         TKdollar,
 #endif
 
diff --git a/src/dmd/backend/ty.h b/src/dmd/backend/ty.h
index 188ed4818..628ca9733 100644
--- a/src/dmd/backend/ty.h
+++ b/src/dmd/backend/ty.h
@@ -180,7 +180,7 @@ enum
     mTYnothrow      = 0x00200000,    // nothrow function
 
     // Used only by C/C++ compiler
-#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
     mTYnoret        = 0x01000000,    // function has no return
     mTYtransu       = 0x01000000,    // transparent union
 #else
@@ -194,7 +194,7 @@ enum
     mTYsyscall      = 0x40000000,
     mTYjava         = 0x80000000,
 
-#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
     mTYTFF          = 0xFE000000,
 #else
     mTYTFF          = 0xFF000000,
@@ -319,7 +319,7 @@ inline unsigned tysimd(tym_t ty) { return tytab[ty & 0xFF] & TYFLsimd; }
 /* Array to give the 'relaxed' type for relaxed type checking   */
 extern unsigned char _tyrelax[];
 #define type_relax      (config.flags3 & CFG3relax)     // !=0 if relaxed type checking
-#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
 #define type_semirelax  (config.flags3 & CFG3semirelax) // !=0 if semi-relaxed type checking
 #else
 #define type_semirelax  type_relax
diff --git a/src/dmd/backend/var.c b/src/dmd/backend/var.c
index 27bbe037a..1cdc78c84 100644
--- a/src/dmd/backend/var.c
+++ b/src/dmd/backend/var.c
@@ -57,7 +57,7 @@ int linkage_spec = 0;           /* using the default                    */
 #if MEMMODELS == 1
 tym_t functypetab[LINK_MAXDIM] =
 {
-#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS
+#if TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX
     TYnfunc,
     TYnpfunc,
     TYnpfunc,
diff --git a/src/dmd/cond.d b/src/dmd/cond.d
index 7a8545b96..9e4727de5 100644
--- a/src/dmd/cond.d
+++ b/src/dmd/cond.d
@@ -584,6 +584,7 @@ extern (C++) final class VersionCondition : DVCondition
             case "Win32":
             case "Win64":
             case "linux":
+            case "PowerNex":
             case "OSX":
             case "iOS":
             case "TVOS":
diff --git a/src/dmd/e2ir.d b/src/dmd/e2ir.d
index 3b2e903ed..170d59c5d 100644
--- a/src/dmd/e2ir.d
+++ b/src/dmd/e2ir.d
@@ -291,7 +291,8 @@ private elem *callfunc(Loc loc,
         if ((global.params.isLinux ||
              global.params.isOSX ||
              global.params.isFreeBSD ||
-             global.params.isSolaris) && tf.linkage != LINKd)
+             global.params.isSolaris ||
+             global.params.isPowerNex) && tf.linkage != LINKd)
         {
                 // ehidden goes last on Linux/OSX C++
         }
@@ -1988,7 +1989,7 @@ elem *toElem(Expression e, IRState *irs)
                 {
                     ts = symbol_genauto(Type_toCtype(t1));
                     int rtl;
-                    if (global.params.isLinux || global.params.isFreeBSD || global.params.isSolaris ||
+                    if (global.params.isLinux || global.params.isFreeBSD || global.params.isSolaris || global.params.isPowerNex ||
                         global.params.is64bit && global.params.isWindows)
                         rtl = RTLSYM__DINVARIANT;
                     else
diff --git a/src/dmd/globals.d b/src/dmd/globals.d
index 4a90a82f0..66ad0f5b0 100644
--- a/src/dmd/globals.d
+++ b/src/dmd/globals.d
@@ -31,6 +31,7 @@ enum IN_GCC     = xversion!`IN_GCC`;
 enum TARGET_LINUX   = xversion!`linux`;
 enum TARGET_OSX     = xversion!`OSX`;
 enum TARGET_FREEBSD = xversion!`FreeBSD`;
+enum TARGET_POWERNEX = xversion!`PowerNex`;
 enum TARGET_OPENBSD = xversion!`OpenBSD`;
 enum TARGET_SOLARIS = xversion!`Solaris`;
 enum TARGET_WINDOS  = xversion!`Windows`;
@@ -94,6 +95,7 @@ struct Param
     bool is64bit = (size_t.sizeof == 8);  // generate 64 bit code; true by default for 64 bit dmd
     bool isLP64;            // generate code for LP64
     bool isLinux;           // generate code for linux
+    bool isPowerNex;        // generate code for PowerNex
     bool isOSX;             // generate code for Mac OSX
     bool isWindows;         // generate code for Windows
     bool isFreeBSD;         // generate code for FreeBSD
@@ -307,7 +309,7 @@ struct Global
         {
             obj_ext = "obj";
         }
-        else static if (TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS)
+        else static if (TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX)
         {
             obj_ext = "o";
         }
@@ -319,7 +321,7 @@ struct Global
         {
             lib_ext = "lib";
         }
-        else static if (TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS)
+        else static if (TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX)
         {
             lib_ext = "a";
         }
@@ -331,7 +333,7 @@ struct Global
         {
             dll_ext = "dll";
         }
-        else static if (TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS)
+        else static if (TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX)
         {
             dll_ext = "so";
         }
@@ -347,7 +349,7 @@ struct Global
         {
             run_noext = false;
         }
-        else static if (TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS)
+        else static if (TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX)
         {
             // Allow 'script' D source files to have no extension.
             run_noext = true;
diff --git a/src/dmd/globals.h b/src/dmd/globals.h
index 07538b8ff..aa56afaba 100644
--- a/src/dmd/globals.h
+++ b/src/dmd/globals.h
@@ -85,6 +85,7 @@ struct Param
     bool is64bit;       // generate 64 bit code
     bool isLP64;        // generate code for LP64
     bool isLinux;       // generate code for linux
+    bool isPowerNex;    // generate code for PowerNex
     bool isOSX;         // generate code for Mac OSX
     bool isWindows;     // generate code for Windows
     bool isFreeBSD;     // generate code for FreeBSD
diff --git a/src/dmd/lib.d b/src/dmd/lib.d
index 68e012e40..c48aececa 100644
--- a/src/dmd/lib.d
+++ b/src/dmd/lib.d
@@ -28,7 +28,7 @@ static if (TARGET_WINDOS)
     import dmd.libomf;
     import dmd.libmscoff;
 }
-else static if (TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS)
+else static if (TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX)
 {
     import dmd.libelf;
 }
@@ -51,7 +51,7 @@ class Library
         {
             return (global.params.mscoff || global.params.is64bit) ? LibMSCoff_factory() : LibOMF_factory();
         }
-        else static if (TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS)
+        else static if (TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX)
         {
             return LibElf_factory();
         }
diff --git a/src/dmd/mars.d b/src/dmd/mars.d
index 6344b54cd..a337b15c4 100644
--- a/src/dmd/mars.d
+++ b/src/dmd/mars.d
@@ -75,7 +75,7 @@ private void logo()
  */
 private  void usage()
 {
-    static if (TARGET_LINUX)
+    static if (TARGET_LINUX || TARGET_POWERNEX)
     {
         const(char)* fpic = "\n  -fPIC            generate position independent code";
     }
@@ -423,6 +423,10 @@ Language changes listed by -transition=id:
         {
             browse("http://dlang.org/dmd-openbsd.html");
         }
+        version (PowerNex)
+        {
+            browse("http://powernex.net/dmd");
+        }
         return EXIT_SUCCESS;
     }
 
@@ -464,7 +468,7 @@ Language changes listed by -transition=id:
     {
         global.params.pic = 1;
     }
-    static if (TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS)
+    static if (TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX)
     {
         if (global.params.lib && global.params.dll)
             error(Loc(), "cannot mix -lib and -shared");
@@ -642,7 +646,7 @@ Language changes listed by -transition=id:
                 libmodules.push(files[i]);
                 continue;
             }
-            static if (TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS)
+            static if (TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX)
             {
                 if (FileName.equals(ext, global.dll_ext))
                 {
@@ -1282,7 +1286,7 @@ private void setDefaultLibrary()
             else
                 global.params.defaultlibname = "phobos";
         }
-        else static if (TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS)
+        else static if (TARGET_LINUX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX)
         {
             global.params.defaultlibname = "libphobos2.a";
         }
@@ -1353,6 +1357,13 @@ private void addDefaultVersionIdentifiers()
         VersionCondition.addPredefinedGlobalIdent("ELFv1");
         global.params.isSolaris = true;
     }
+    else static if (TARGET_POWERNEX)
+    {
+        VersionCondition.addPredefinedGlobalIdent("Posix");
+        VersionCondition.addPredefinedGlobalIdent("PowerNex");
+        VersionCondition.addPredefinedGlobalIdent("ELFv1");
+        global.params.isPowerNex = true;
+    }
     else
     {
         static assert(0, "fix this");
@@ -1610,7 +1621,7 @@ private bool parseCommandLine(const ref Strings arguments, const size_t argc, re
             }
             else if (strcmp(p + 1, "fPIC") == 0)
             {
-                static if (TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS)
+                static if (TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX)
                 {
                     params.pic = 1;
                 }
diff --git a/src/dmd/mars.h b/src/dmd/mars.h
index 709256cb8..fd19a9fba 100644
--- a/src/dmd/mars.h
+++ b/src/dmd/mars.h
@@ -41,6 +41,7 @@ Macros defined by the compiler, not the code:
         __FreeBSD__     FreeBSD
         __OpenBSD__     OpenBSD
         __sun           Solaris, OpenSolaris, SunOS, OpenIndiana, etc
+        __PowerNex__    PowerNex
 
 For the target systems, there are the target operating system and
 the target object file format:
@@ -52,6 +53,7 @@ the target object file format:
         TARGET_FREEBSD  Covers 32 and 64 bit FreeBSD
         TARGET_OPENBSD  Covers 32 and 64 bit OpenBSD
         TARGET_SOLARIS  Covers 32 and 64 bit Solaris
+        TARGET_POWERNEX Covers 64 bit PowerNex
 
     It is expected that the compiler for each platform will be able
     to generate 32 and 64 bit code from the same compiler binary.
diff --git a/src/dmd/target.d b/src/dmd/target.d
index 85e62f0a4..f64257026 100644
--- a/src/dmd/target.d
+++ b/src/dmd/target.d
@@ -84,7 +84,7 @@ struct Target
             ptrsize = 8;
             classinfosize = 0x98; // 152
         }
-        if (global.params.isLinux || global.params.isFreeBSD || global.params.isOpenBSD || global.params.isSolaris)
+        if (global.params.isLinux || global.params.isFreeBSD || global.params.isOpenBSD || global.params.isSolaris || global.params.isPowerNex)
         {
             realsize = 12;
             realpad = 2;
@@ -117,7 +117,7 @@ struct Target
             assert(0);
         if (global.params.is64bit)
         {
-            if (global.params.isLinux || global.params.isFreeBSD || global.params.isSolaris)
+            if (global.params.isLinux || global.params.isFreeBSD || global.params.isSolaris || global.params.isPowerNex)
             {
                 realsize = 16;
                 realpad = 6;
@@ -133,7 +133,7 @@ struct Target
         if (global.params.is64bit && global.params.isWindows)
             c_long_doublesize = 8;
 
-        cppExceptions = global.params.isLinux || global.params.isFreeBSD ||
+        cppExceptions = global.params.isLinux || global.params.isFreeBSD || global.params.isPowerNex ||
             global.params.isOSX;
     }
 
@@ -150,7 +150,7 @@ struct Target
         case Tcomplex80:
             return Target.realalignsize;
         case Tcomplex32:
-            if (global.params.isLinux || global.params.isOSX || global.params.isFreeBSD || global.params.isOpenBSD || global.params.isSolaris)
+            if (global.params.isLinux || global.params.isOSX || global.params.isFreeBSD || global.params.isOpenBSD || global.params.isSolaris || global.params.isPowerNex)
                 return 4;
             break;
         case Tint64:
@@ -158,7 +158,7 @@ struct Target
         case Tfloat64:
         case Timaginary64:
         case Tcomplex64:
-            if (global.params.isLinux || global.params.isOSX || global.params.isFreeBSD || global.params.isOpenBSD || global.params.isSolaris)
+            if (global.params.isLinux || global.params.isOSX || global.params.isFreeBSD || global.params.isOpenBSD || global.params.isSolaris || global.params.isPowerNex)
                 return global.params.is64bit ? 8 : 4;
             break;
         default:
@@ -221,6 +221,11 @@ struct Target
             // sizeof(pthread_mutex_t) for Solaris.
             return 24;
         }
+        else if (global.params.isPowerNex)
+        {
+            // sizeof(pthread_mutex_t) for PowerNex.
+            return 64;
+        }
         assert(0);
     }
 
@@ -235,7 +240,7 @@ struct Target
         {
             return Type.tchar.pointerTo();
         }
-        else if (global.params.isLinux || global.params.isFreeBSD || global.params.isOpenBSD || global.params.isSolaris || global.params.isOSX)
+        else if (global.params.isLinux || global.params.isFreeBSD || global.params.isOpenBSD || global.params.isSolaris || global.params.isPowerNex || global.params.isOSX)
         {
             if (global.params.is64bit)
             {
@@ -437,7 +442,7 @@ struct Target
 
     extern (C++) static const(char)* toCppMangle(Dsymbol s)
     {
-        static if (TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS)
+        static if (TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX)
             return toCppMangleItanium(s);
         else static if (TARGET_WINDOS)
             return toCppMangleMSVC(s);
@@ -447,7 +452,7 @@ struct Target
 
     extern (C++) static const(char)* cppTypeInfoMangle(ClassDeclaration cd)
     {
-        static if (TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS)
+        static if (TARGET_LINUX || TARGET_OSX || TARGET_FREEBSD || TARGET_OPENBSD || TARGET_SOLARIS || TARGET_POWERNEX)
             return cppTypeInfoMangleItanium(cd);
         else static if (TARGET_WINDOS)
             return cppTypeInfoMangleMSVC(cd);
diff --git a/src/dmd/toir.d b/src/dmd/toir.d
index 233584e44..d124a7852 100644
--- a/src/dmd/toir.d
+++ b/src/dmd/toir.d
@@ -1011,7 +1011,7 @@ Lagain:
         if (tns.ty != Tstruct)
         {
 L2:
-            if (global.params.isLinux && tf.linkage != LINKd && !global.params.is64bit)
+            if ((global.params.isLinux || global.params.isPowerNex) && tf.linkage != LINKd && !global.params.is64bit)
             {
                                                 // 32 bit C/C++ structs always on stack
             }
@@ -1038,7 +1038,7 @@ L2:
     if (tns.ty == Tstruct)
     {
         StructDeclaration sd = (cast(TypeStruct)tns).sym;
-        if (global.params.isLinux && tf.linkage != LINKd && !global.params.is64bit)
+        if ((global.params.isLinux || global.params.isPowerNex) && tf.linkage != LINKd && !global.params.is64bit)
         {
             if (sd.ident == Id.__c_long || sd.ident == Id.__c_ulong)
                 return RETregs;
@@ -1087,7 +1087,7 @@ L2:
         //printf("  3 RETstack\n");
         return RETstack;
     }
-    else if ((global.params.isLinux || global.params.isOSX || global.params.isFreeBSD || global.params.isSolaris) &&
+    else if ((global.params.isLinux || global.params.isOSX || global.params.isFreeBSD || global.params.isSolaris || global.params.isPowerNex) &&
              tf.linkage == LINKc &&
              tns.iscomplex())
     {
diff --git a/test/fail_compilation/reserved_version.d b/test/fail_compilation/reserved_version.d
index 89bde619d..096ac3fae 100644
--- a/test/fail_compilation/reserved_version.d
+++ b/test/fail_compilation/reserved_version.d
@@ -100,6 +100,7 @@ fail_compilation/reserved_version.d(201): Error: version identifier `none` is re
 fail_compilation/reserved_version.d(202): Error: version identifier `AsmJS` is reserved and cannot be set
 fail_compilation/reserved_version.d(203): Error: version identifier `Emscripten` is reserved and cannot be set
 fail_compilation/reserved_version.d(204): Error: version identifier `WebAssembly` is reserved and cannot be set
+fail_compilation/reserved_version.d(205): Error: version identifier `PowerNex` is reserved and cannot be set
 ---
 */
 
@@ -206,6 +207,7 @@ version = none;
 version = AsmJS;
 version = Emscripten;
 version = WebAssembly;
+version = PowerNex;
 
 // This should work though
 debug = DigitalMars;
@@ -303,3 +305,4 @@ debug = all;
 debug = none;
 debug = D_P16;
 debug = MSP430;
+debug = PowerNex;
-- 
2.16.1

